upstream auth-service {
    server host.docker.internal:8081;
}

upstream team-service {
    server host.docker.internal:8082;
}

upstream core-service {
    server host.docker.internal:8083;
}

server {
    listen 8080;
    client_max_body_size 50M;

    # ========================
    # Auth Service (8081)
    # ========================
    location /auth/ {
        proxy_pass http://auth-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ========================
    # Team Service (8082)
    # ========================

    # 저장소 CRUD
    location /api/repositories {
        proxy_pass http://team-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 멤버 API (서버 실제 경로)
    location ~ ^/api/teams/([^/]+)/members {
        proxy_pass http://team-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 클라이언트 호환: /repositories/{id}/members → /api/teams/{id}/members
    location ~ ^/repositories/([^/]+)/members(.*)$ {
        rewrite ^/repositories/([^/]+)/members(.*)$ /api/teams/$1/members$2 break;
        proxy_pass http://team-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 엣지노드 API
    location /edge-nodes/ {
        proxy_pass http://team-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ========================
    # Core Service (8083)
    # ========================

    # 태스크 API - 팀별 태스크 (업로드, 목록, 삭제)
    location ~ ^/api/teams/([^/]+)/tasks {
        proxy_pass http://core-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 태스크 API - 클라이언트 업로드 (POST /api/tasks)
    location = /api/tasks {
        proxy_pass http://core-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 태스크 API - 개별 태스크 다운로드
    # 클라이언트 호환: /api/tasks/{id} → /api/tasks/{id}/data
    location ~ ^/api/tasks/([^/]+)$ {
        rewrite ^/api/tasks/([^/]+)$ /api/tasks/$1/data break;
        proxy_pass http://core-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 태스크 API - /data 포함 경로 (직접 호출 시)
    location ~ ^/api/tasks/([^/]+)/data$ {
        proxy_pass http://core-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 클라이언트 호환: /api/documents → /api/tasks (기존 URL 호환)
    location = /api/documents {
        rewrite ^/api/documents$ /api/tasks break;
        proxy_pass http://core-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 클라이언트 호환: /api/documents/{id} → /api/tasks/{id}/data
    location ~ ^/api/documents/([^/]+)$ {
        rewrite ^/api/documents/([^/]+)$ /api/tasks/$1/data break;
        proxy_pass http://core-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 데모 API
    location ~ ^/api/teams/([^/]+)/demos {
        proxy_pass http://core-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 보안 API (핸드셰이크)
    location /api/security/ {
        proxy_pass http://core-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 동기화 API
    location /api/sync/ {
        proxy_pass http://core-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
